version: '3.8'

# ================================================================
# WERKFLOW ENTERPRISE PLATFORM - DOCKER COMPOSE
# ================================================================
# Complete local development environment for all services
# ================================================================

services:
  # ================================================================
  # INFRASTRUCTURE SERVICES
  # ================================================================

  # PostgreSQL Database (Single instance, multiple schemas)
  postgres:
    image: postgres:15-alpine
    container_name: werkflow-postgres
    environment:
      POSTGRES_DB: werkflow
      POSTGRES_USER: werkflow_admin
      POSTGRES_PASSWORD: werkflow_secure_pass
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5433:5432"  # External 5433 to avoid conflicts
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    networks:
      - werkflow-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U werkflow_admin -d werkflow"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Keycloak PostgreSQL Database
  keycloak-postgres:
    image: postgres:15-alpine
    container_name: werkflow-keycloak-db
    environment:
      POSTGRES_DB: keycloak_db
      POSTGRES_USER: keycloak_user
      POSTGRES_PASSWORD: keycloak_pass
    volumes:
      - keycloak_postgres_data:/var/lib/postgresql/data
    networks:
      - werkflow-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak_user -d keycloak_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Keycloak Identity and Access Management
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: werkflow-keycloak
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-postgres:5432/keycloak_db
      KC_DB_USERNAME: keycloak_user
      KC_DB_PASSWORD: keycloak_pass
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: 8090
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_LOG_LEVEL: info
      KC_METRICS_ENABLED: true
      KC_HEALTH_ENABLED: true
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin123
    command: start-dev
    ports:
      - "8090:8080"
    depends_on:
      keycloak-postgres:
        condition: service_healthy
    networks:
      - werkflow-network
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\r\nhost: http://localhost\r\nConnection: close\r\n\r\n' >&3;if [ $? -eq 0 ]; then echo 'Healthcheck Successful';exit 0;else echo 'Healthcheck Failed';exit 1;fi;"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # pgAdmin for database management
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: werkflow-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@werkflow.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - werkflow-network
    depends_on:
      - postgres
    restart: unless-stopped

  # ================================================================
  # BACKEND SERVICES
  # ================================================================

  # Flowable Engine Service
  engine-service:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: engine-service
    container_name: werkflow-engine
    env_file:
      - ../../.env.shared
      - ../../.env.engine
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/werkflow
      SPRING_DATASOURCE_USERNAME: werkflow_admin
      SPRING_DATASOURCE_PASSWORD: werkflow_secure_pass
      SPRING_DATASOURCE_SCHEMA: flowable
      SERVER_PORT: 8081
    ports:
      - "8081:8081"
    volumes:
      - engine_data:/app/process-definitions
      - engine_logs:/app/logs
    networks:
      - werkflow-network
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    restart: unless-stopped

  # HR Service
  hr-service:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: hr-service
    container_name: werkflow-hr
    env_file:
      - ../../.env.shared
      - ../../.env.hr
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/werkflow
      SPRING_DATASOURCE_USERNAME: werkflow_admin
      SPRING_DATASOURCE_PASSWORD: werkflow_secure_pass
      SPRING_DATASOURCE_SCHEMA: hr_service
      SERVER_PORT: 8082
    ports:
      - "8082:8082"
    volumes:
      - hr_documents:/app/hr-documents
      - hr_logs:/app/logs
    networks:
      - werkflow-network
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    restart: unless-stopped

  # Admin Service (Phase 1 - Week 7-8)
  admin-service:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: admin-service
    container_name: werkflow-admin
    env_file:
      - ../../.env.shared
      - ../../.env.admin
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/werkflow
      SPRING_DATASOURCE_USERNAME: werkflow_admin
      SPRING_DATASOURCE_PASSWORD: werkflow_secure_pass
      SPRING_DATASOURCE_SCHEMA: admin_service
      SERVER_PORT: 8083
    ports:
      - "8083:8083"
    volumes:
      - admin_logs:/app/logs
    networks:
      - werkflow-network
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    restart: unless-stopped

  # Inventory Service (Phase 3)
  inventory-service:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: inventory-service
    container_name: werkflow-inventory
    env_file:
      - ../../.env.shared
      - ../../.env.inventory
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/werkflow
      SPRING_DATASOURCE_USERNAME: werkflow_admin
      SPRING_DATASOURCE_PASSWORD: werkflow_secure_pass
      SPRING_DATASOURCE_SCHEMA: inventory_service
      SERVER_PORT: 8084
      ADMIN_SERVICE_URL: http://admin-service:8083
      ENGINE_SERVICE_URL: http://engine-service:8081
    ports:
      - "8084:8084"
    volumes:
      - inventory_logs:/app/logs
    networks:
      - werkflow-network
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      admin-service:
        condition: service_started
      engine-service:
        condition: service_started
    restart: unless-stopped

  # ================================================================
  # FRONTEND SERVICES
  # ================================================================

  # Admin Portal (Workflow Designer)
  admin-portal:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: admin-portal
    container_name: werkflow-admin-portal
    environment:
      PORT: 4000
      NODE_ENV: production
      # Backend API URLs (internal Docker network)
      NEXT_PUBLIC_ENGINE_API_URL: http://engine-service:8081/api
      NEXT_PUBLIC_HR_API_URL: http://hr-service:8082/api
      NEXT_PUBLIC_ADMIN_API_URL: http://admin-service:8083/api
      NEXT_PUBLIC_INVENTORY_API_URL: http://inventory-service:8084/api
      # NextAuth
      NEXTAUTH_URL: http://localhost:4000
      # Keycloak (external URL for browser)
      KEYCLOAK_ISSUER: http://localhost:8090/realms/werkflow
    ports:
      - "4000:4000"
    networks:
      - werkflow-network
    depends_on:
      - hr-service
      - engine-service
      - admin-service
      - inventory-service
    restart: unless-stopped

  # HR Portal (Phase 2)
  hr-portal:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: hr-portal
    container_name: werkflow-hr-portal
    environment:
      PORT: 4001
      NODE_ENV: production
      # Backend API URLs (internal Docker network)
      NEXT_PUBLIC_ENGINE_API_URL: http://engine-service:8081/api
      NEXT_PUBLIC_HR_API_URL: http://hr-service:8082/api
      NEXT_PUBLIC_ADMIN_API_URL: http://admin-service:8083/api
      NEXT_PUBLIC_INVENTORY_API_URL: http://inventory-service:8084/api
      # NextAuth
      NEXTAUTH_URL: http://localhost:4001
      NEXTAUTH_SECRET: change-me-in-production
      # Keycloak (external URL for browser)
      KEYCLOAK_CLIENT_ID: werkflow-hr-portal
      KEYCLOAK_CLIENT_SECRET: change-me-in-production
      KEYCLOAK_ISSUER: http://localhost:8090/realms/werkflow
    ports:
      - "4001:4001"
    networks:
      - werkflow-network
    depends_on:
      - hr-service
      - engine-service
      - admin-service
    restart: unless-stopped

# ================================================================
# VOLUMES
# ================================================================
volumes:
  postgres_data:
    driver: local
  keycloak_postgres_data:
    driver: local
  pgadmin_data:
    driver: local
  engine_data:
    driver: local
  engine_logs:
    driver: local
  hr_documents:
    driver: local
  hr_logs:
    driver: local
  admin_logs:
    driver: local
  inventory_logs:
    driver: local

# ================================================================
# NETWORKS
# ================================================================
networks:
  werkflow-network:
    driver: bridge
    name: werkflow-network
