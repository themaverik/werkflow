version: '3.8'

# ================================================================
# WERKFLOW ENTERPRISE PLATFORM - DOCKER COMPOSE
# ================================================================
# Complete local development environment for all services
# ================================================================

services:
  # ================================================================
  # INFRASTRUCTURE SERVICES
  # ================================================================

  # PostgreSQL Database (Single instance, multiple schemas)
  postgres:
    image: postgres:15-alpine
    container_name: werkflow-postgres
    environment:
      POSTGRES_DB: werkflow
      POSTGRES_USER: werkflow_admin
      POSTGRES_PASSWORD: werkflow_secure_pass
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5433:5432"  # External 5433 to avoid conflicts
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    networks:
      - werkflow-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U werkflow_admin -d werkflow"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Keycloak PostgreSQL Database
  keycloak-postgres:
    image: postgres:15-alpine
    container_name: werkflow-keycloak-db
    environment:
      POSTGRES_DB: keycloak_db
      POSTGRES_USER: keycloak_user
      POSTGRES_PASSWORD: keycloak_pass
    volumes:
      - keycloak_postgres_data:/var/lib/postgresql/data
    networks:
      - werkflow-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak_user -d keycloak_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Keycloak Identity and Access Management
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: werkflow-keycloak
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-postgres:5432/keycloak_db
      KC_DB_USERNAME: keycloak_user
      KC_DB_PASSWORD: keycloak_pass

      # Hostname Configuration for Docker Environment
      # CRITICAL: Using 'start' (production mode) instead of 'start-dev' to enable hostname config
      # Browser accesses Keycloak at localhost:8090 (port-mapped)
      # Containers access Keycloak at keycloak:8080 (internal network)
      # KC_HOSTNAME: Sets the frontend URL that browsers will use
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: 8090
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HOSTNAME_STRICT_BACKCHANNEL: false

      # Enable HTTP (required for local development)
      KC_HTTP_ENABLED: true

      # Proxy mode: Tells Keycloak it's behind a reverse proxy
      # This makes Keycloak respect X-Forwarded-* headers
      KC_PROXY: edge

      # Logging and Metrics
      KC_LOG_LEVEL: info
      KC_METRICS_ENABLED: true
      KC_HEALTH_ENABLED: true

      # Admin Credentials
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin123
    command:
      - start
      - --http-relative-path=/
    ports:
      - "8090:8080"
    depends_on:
      keycloak-postgres:
        condition: service_healthy
    networks:
      - werkflow-network
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\r\nhost: http://localhost\r\nConnection: close\r\n\r\n' >&3;if [ $? -eq 0 ]; then echo 'Healthcheck Successful';exit 0;else echo 'Healthcheck Failed';exit 1;fi;"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # pgAdmin for database management
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: werkflow-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@werkflow.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - werkflow-network
    depends_on:
      - postgres
    restart: unless-stopped

  # ================================================================
  # BACKEND SERVICES
  # ================================================================

  # Flowable Engine Service
  engine-service:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: engine-service
    container_name: werkflow-engine
    env_file:
      - ../../.env.shared
      - ../../.env.engine
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/werkflow
      SPRING_DATASOURCE_USERNAME: werkflow_admin
      SPRING_DATASOURCE_PASSWORD: werkflow_secure_pass
      SPRING_DATASOURCE_SCHEMA: flowable
      SERVER_PORT: 8081

      # Keycloak Configuration for Docker Internal Network
      # Uses keycloak:8080 for container-to-container communication
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/werkflow
    ports:
      - "8081:8081"
    volumes:
      - engine_data:/app/process-definitions
      - engine_logs:/app/logs
    networks:
      - werkflow-network
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    restart: unless-stopped

  # HR Service
  hr-service:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: hr-service
    container_name: werkflow-hr
    env_file:
      - ../../.env.shared
      - ../../.env.hr
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/werkflow
      SPRING_DATASOURCE_USERNAME: werkflow_admin
      SPRING_DATASOURCE_PASSWORD: werkflow_secure_pass
      SPRING_DATASOURCE_SCHEMA: hr_service
      SERVER_PORT: 8082

      # Keycloak Configuration for Docker Internal Network
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/werkflow
    ports:
      - "8082:8082"
    volumes:
      - hr_documents:/app/hr-documents
      - hr_logs:/app/logs
    networks:
      - werkflow-network
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    restart: unless-stopped

  # Admin Service (Phase 1 - Week 7-8)
  admin-service:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: admin-service
    container_name: werkflow-admin
    env_file:
      - ../../.env.shared
      - ../../.env.admin
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/werkflow
      SPRING_DATASOURCE_USERNAME: werkflow_admin
      SPRING_DATASOURCE_PASSWORD: werkflow_secure_pass
      SPRING_DATASOURCE_SCHEMA: admin_service
      SERVER_PORT: 8083

      # Keycloak Configuration for Docker Internal Network
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/werkflow
    ports:
      - "8083:8083"
    volumes:
      - admin_logs:/app/logs
    networks:
      - werkflow-network
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    restart: unless-stopped

  # Finance Service (Phase 3)
  finance-service:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: finance-service
    container_name: werkflow-finance
    env_file:
      - ../../.env.shared
      - ../../.env.finance
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/werkflow
      SPRING_DATASOURCE_USERNAME: werkflow_admin
      SPRING_DATASOURCE_PASSWORD: werkflow_secure_pass
      SPRING_DATASOURCE_SCHEMA: finance_service
      SERVER_PORT: 8084
      ENGINE_SERVICE_URL: http://engine-service:8081
      ADMIN_SERVICE_URL: http://admin-service:8083

      # Keycloak Configuration for Docker Internal Network
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/werkflow
    ports:
      - "8084:8084"

    volumes:
      - finance_logs:/app/logs
    networks:
      - werkflow-network
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      admin-service:
        condition: service_started
      engine-service:
        condition: service_started

    restart: unless-stopped

  # Procurement Service (Phase 3)
  procurement-service:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: procurement-service
    container_name: werkflow-procurement
    env_file:
      - ../../.env.shared
      - ../../.env.procurement
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/werkflow
      SPRING_DATASOURCE_USERNAME: werkflow_admin
      SPRING_DATASOURCE_PASSWORD: werkflow_secure_pass
      SPRING_DATASOURCE_SCHEMA: procurement_service
      SERVER_PORT: 8085
      ADMIN_SERVICE_URL: http://admin-service:8083
      ENGINE_SERVICE_URL: http://engine-service:8081
      FINANCE_SERVICE_URL: http://finance-service:8084

      # Keycloak Configuration for Docker Internal Network
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/werkflow
    ports:
      - "8085:8085"

    volumes:
      - procurement_logs:/app/logs
    networks:
      - werkflow-network
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      admin-service:
        condition: service_started
      engine-service:
        condition: service_started
      finance-service:
        condition: service_started
    restart: unless-stopped

  # Inventory Service (Phase 3)
  inventory-service:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: inventory-service
    container_name: werkflow-inventory
    env_file:
      - ../../.env.shared
      - ../../.env.inventory
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/werkflow
      SPRING_DATASOURCE_USERNAME: werkflow_admin
      SPRING_DATASOURCE_PASSWORD: werkflow_secure_pass
      SPRING_DATASOURCE_SCHEMA: inventory_service
      SERVER_PORT: 8086
      ENGINE_SERVICE_URL: http://engine-service:8081
      ADMIN_SERVICE_URL: http://admin-service:8083

      # Keycloak Configuration for Docker Internal Network
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/werkflow
    ports:
      - "8086:8086"
    volumes:
      - inventory_logs:/app/logs
    networks:
      - werkflow-network
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      admin-service:
        condition: service_started
      engine-service:
        condition: service_started
      finance-service:
        condition: service_started

    restart: unless-stopped

  # ================================================================
  # FRONTEND SERVICES
  # ================================================================

  # Admin Portal (Workflow Designer)
  admin-portal:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: admin-portal
    container_name: werkflow-admin-portal
    environment:
      PORT: 4000
      NODE_ENV: production
      # Backend API URLs (internal Docker network)
      NEXT_PUBLIC_ENGINE_API_URL: http://engine-service:8081/api
      NEXT_PUBLIC_HR_API_URL: http://hr-service:8082/api
      NEXT_PUBLIC_ADMIN_API_URL: http://admin-service:8083/api
      NEXT_PUBLIC_FINANCE_API_URL: http://finance-service:8084/api
      NEXT_PUBLIC_PROCUREMENT_API_URL: http://procurement-service:8085/api
      NEXT_PUBLIC_INVENTORY_API_URL: http://inventory-service:8086/api

      # NextAuth Configuration
      NEXTAUTH_URL: http://localhost:4000
      NEXTAUTH_SECRET: xg7bVqYgFgTDwpVWe6gbyWwZVb8f0Yd1Wo+ZGuKdm/U=
      AUTH_TRUST_HOST: true
      
      KEYCLOAK_ISSUER: http://localhost:8090/realms/werkflow
      # Keycloak OAuth2 Configuration (Dual-URL Strategy for Docker)
      # KEYCLOAK_ISSUER_INTERNAL: Used for server-side OIDC discovery and API calls
      # Uses Docker internal network (keycloak:8080) - container-to-container communication
      KEYCLOAK_ISSUER_INTERNAL: http://keycloak:8080/realms/werkflow

      # KEYCLOAK_ISSUER_PUBLIC: The issuer that Keycloak advertises in tokens
      # Must match what Keycloak returns (localhost:8090 via KC_HOSTNAME/KC_PROXY)
      # Used for token validation - NextAuth checks this against token claims
      KEYCLOAK_ISSUER_PUBLIC: http://localhost:8090/realms/werkflow

      # KEYCLOAK_ISSUER_BROWSER: Used for browser redirects during OAuth flow
      # Must be accessible from user's browser (localhost:8090 on host machine)
      KEYCLOAK_ISSUER_BROWSER: http://localhost:8090/realms/werkflow

      KEYCLOAK_CLIENT_ID: werkflow-admin-portal
      KEYCLOAK_CLIENT_SECRET: 4uohM7y1sGkOcR2gTR1APo4JDmkwRxSv
    ports:
      - "4000:4000"
    networks:
      - werkflow-network
    depends_on:
      - hr-service
      - engine-service
      - admin-service
      - finance-service
      - procurement-service
      - inventory-service
    restart: unless-stopped

  # HR Portal (Phase 2)
  hr-portal:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: hr-portal
    container_name: werkflow-hr-portal
    environment:
      PORT: 4001
      NODE_ENV: production
      # Backend API URLs (internal Docker network)
      NEXT_PUBLIC_ENGINE_API_URL: http://engine-service:8081/api
      NEXT_PUBLIC_HR_API_URL: http://hr-service:8082/api
      NEXT_PUBLIC_ADMIN_API_URL: http://admin-service:8083/api
      NEXT_PUBLIC_FINANCE_API_URL: http://finance-service:8084/api
      NEXT_PUBLIC_PROCUREMENT_API_URL: http://procurement-service:8085/api
      NEXT_PUBLIC_INVENTORY_API_URL: http://inventory-service:8086/api

      # NextAuth Configuration
      NEXTAUTH_URL: http://localhost:4001
      NEXTAUTH_SECRET: xg7bVqYgFgTDwpVWe6gbyWwZVb8f0Yd1Wo+ZGuKdm/U=
      AUTH_TRUST_HOST: true

      # Keycloak OAuth2 Configuration (Dual-URL Strategy for Docker)
      # KEYCLOAK_ISSUER_INTERNAL: Used for server-side OIDC discovery and API calls
      # Uses Docker internal network (keycloak:8080) - container-to-container communication
      KEYCLOAK_ISSUER_INTERNAL: http://keycloak:8080/realms/werkflow

      # KEYCLOAK_ISSUER_PUBLIC: The issuer that Keycloak advertises in tokens
      # Must match what Keycloak returns (localhost:8090 via KC_HOSTNAME/KC_PROXY)
      # Used for token validation - NextAuth checks this against token claims
      KEYCLOAK_ISSUER_PUBLIC: http://localhost:8090/realms/werkflow

      # KEYCLOAK_ISSUER_BROWSER: Used for browser redirects during OAuth flow
      # Must be accessible from user's browser (localhost:8090 on host machine)
      KEYCLOAK_ISSUER_BROWSER: http://localhost:8090/realms/werkflow

      KEYCLOAK_CLIENT_ID: werkflow-hr-portal
      KEYCLOAK_CLIENT_SECRET: HR_PORTAL_SECRET_2024_SECURE
    ports:
      - "4001:4001"
    networks:
      - werkflow-network
    depends_on:
      - hr-service
      - engine-service
      - admin-service
    restart: unless-stopped

# ================================================================
# VOLUMES
# ================================================================
volumes:
  postgres_data:
    driver: local
  keycloak_postgres_data:
    driver: local
  pgadmin_data:
    driver: local
  engine_data:
    driver: local
  engine_logs:
    driver: local
  hr_documents:
    driver: local
  hr_logs:
    driver: local
  admin_logs:
    driver: local
  finance_logs:
    driver: local
  procurement_logs:
    driver: local
  inventory_logs:
    driver: local

# ================================================================
# NETWORKS
# ================================================================
networks:
  werkflow-network:
    driver: bridge
    name: werkflow-network
