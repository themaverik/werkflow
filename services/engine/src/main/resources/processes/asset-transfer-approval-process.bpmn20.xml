<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
             typeLanguage="http://www.w3.org/2001/XMLSchema"
             expressionLanguage="http://www.w3.org/1999/XPath"
             targetNamespace="http://werkflow.com/bpmn/inventory">

  <process id="asset-transfer-approval-process" name="Asset Transfer Approval Process" isExecutable="true">

    <documentation>Asset transfer workflow with custody tracking and multi-level approvals for high-value assets</documentation>

    <!-- Start Event -->
    <startEvent id="startEvent" name="Transfer Request Submitted" flowable:formKey="asset-transfer-request">
      <documentation>Employee or manager submits an asset transfer request</documentation>
    </startEvent>

    <!-- Service Task: Create Transfer Request in Inventory Service -->
    <serviceTask id="createTransferRequest" name="Create Transfer Request"
                 flowable:expression="${execution.setVariable('transferId', inventoryService.createTransferRequest(execution.getVariables()))}">
      <documentation>Creates asset transfer request record in Inventory Service via REST API</documentation>
    </serviceTask>

    <!-- Service Task: Verify Asset Availability -->
    <serviceTask id="verifyAsset" name="Verify Asset Availability"
                 flowable:expression="${execution.setVariable('assetDetails', inventoryService.verifyAsset(assetId))}">
      <documentation>Verifies asset exists, is available, and retrieves asset details including value</documentation>
    </serviceTask>

    <!-- Exclusive Gateway: Asset Available? -->
    <exclusiveGateway id="availabilityGateway" name="Asset Available?" />

    <!-- Service Task: Check Current Custody -->
    <serviceTask id="checkCustody" name="Check Current Custody"
                 flowable:expression="${execution.setVariable('currentCustodian', inventoryService.getCurrentCustodian(assetId))}">
      <documentation>Retrieves current custodian information</documentation>
    </serviceTask>

    <!-- User Task: Current Custodian Release Approval -->
    <userTask id="custodianReleaseApproval" name="Release Approval" flowable:assignee="${currentCustodian}" flowable:formKey="release-approval">
      <documentation>Current custodian approves release of the asset</documentation>
    </userTask>

    <!-- Exclusive Gateway: Released? -->
    <exclusiveGateway id="releaseGateway" name="Released?" />

    <!-- Exclusive Gateway: High-Value Asset? -->
    <exclusiveGateway id="valueGateway" name="Value > $5,000?" />

    <!-- User Task: Department Manager Approval (for high-value assets) -->
    <userTask id="managerApproval" name="Manager Review" flowable:candidateGroups="INVENTORY_MANAGER" flowable:formKey="transfer-approval">
      <documentation>Department manager approves high-value asset transfers</documentation>
    </userTask>

    <!-- Merge Gateway -->
    <exclusiveGateway id="mergeGateway" name="Merge Paths" />

    <!-- User Task: New Custodian Acceptance -->
    <userTask id="custodianAcceptance" name="Accept Asset" flowable:assignee="${newCustodian}" flowable:formKey="asset-acceptance">
      <documentation>New custodian accepts responsibility for the asset</documentation>
    </userTask>

    <!-- Exclusive Gateway: Accepted? -->
    <exclusiveGateway id="acceptanceGateway" name="Accepted?" />

    <!-- Service Task: Update Custody Record -->
    <serviceTask id="updateCustody" name="Update Custody Record"
                 flowable:expression="${inventoryService.updateCustody(assetId, newCustodian, transferId)}">
      <documentation>Updates custody record in Inventory Service with new custodian</documentation>
    </serviceTask>

    <!-- Service Task: Update Asset Location -->
    <serviceTask id="updateLocation" name="Update Asset Location"
                 flowable:expression="${inventoryService.updateAssetLocation(assetId, newLocation, newDepartment)}">
      <documentation>Updates asset location and department assignment</documentation>
    </serviceTask>

    <!-- Service Task: Create Transfer Record -->
    <serviceTask id="createTransferRecord" name="Create Transfer Record"
                 flowable:expression="${inventoryService.createTransferRecord(transferId, assetId, currentCustodian, newCustodian)}">
      <documentation>Creates historical transfer record for audit trail</documentation>
    </serviceTask>

    <!-- Service Task: Update Transfer Status - Completed -->
    <serviceTask id="updateCompleted" name="Update Status: Completed"
                 flowable:expression="${inventoryService.updateTransferStatus(transferId, 'COMPLETED')}">
      <documentation>Marks transfer request as completed</documentation>
    </serviceTask>

    <!-- Service Task: Send Completion Notification -->
    <serviceTask id="sendCompletionNotification" name="Send Completion Notification"
                 flowable:expression="${notificationService.sendTransferNotification(requesterEmail, currentCustodian, newCustodian, assetDetails)}">
      <documentation>Sends notification to all parties about successful transfer</documentation>
    </serviceTask>

    <!-- Service Task: Update Transfer Status - Rejected -->
    <serviceTask id="updateRejected" name="Update Status: Rejected"
                 flowable:expression="${inventoryService.updateTransferStatus(transferId, 'REJECTED', execution.getVariable('rejectionReason'))}">
      <documentation>Marks transfer request as rejected</documentation>
    </serviceTask>

    <!-- Service Task: Send Rejection Notification -->
    <serviceTask id="sendRejectionNotification" name="Send Rejection Notification"
                 flowable:expression="${notificationService.sendEmail(requesterEmail, 'Asset Transfer Rejected', rejectionMessage)}">
      <documentation>Sends rejection notification to requester</documentation>
    </serviceTask>

    <!-- End Events -->
    <endEvent id="endEventCompleted" name="Transfer Completed" />
    <endEvent id="endEventRejected" name="Transfer Rejected" />
    <endEvent id="endEventUnavailable" name="Asset Unavailable" />

    <!-- Sequence Flows -->
    <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="createTransferRequest" />
    <sequenceFlow id="flow2" sourceRef="createTransferRequest" targetRef="verifyAsset" />
    <sequenceFlow id="flow3" sourceRef="verifyAsset" targetRef="availabilityGateway" />

    <!-- Availability Gateway Flows -->
    <sequenceFlow id="available" sourceRef="availabilityGateway" targetRef="checkCustody">
      <conditionExpression xsi:type="tFormalExpression">${assetDetails.status == 'AVAILABLE' || assetDetails.status == 'IN_USE'}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="unavailable" sourceRef="availabilityGateway" targetRef="endEventUnavailable">
      <conditionExpression xsi:type="tFormalExpression">${assetDetails.status == 'MAINTENANCE' || assetDetails.status == 'RETIRED'}</conditionExpression>
    </sequenceFlow>

    <sequenceFlow id="flow4" sourceRef="checkCustody" targetRef="custodianReleaseApproval" />
    <sequenceFlow id="flow5" sourceRef="custodianReleaseApproval" targetRef="releaseGateway" />

    <!-- Release Gateway Flows -->
    <sequenceFlow id="released" sourceRef="releaseGateway" targetRef="valueGateway">
      <conditionExpression xsi:type="tFormalExpression">${releaseDecision == 'APPROVED'}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="notReleased" sourceRef="releaseGateway" targetRef="updateRejected">
      <conditionExpression xsi:type="tFormalExpression">${releaseDecision == 'REJECTED'}</conditionExpression>
    </sequenceFlow>

    <!-- Value Gateway Flows -->
    <sequenceFlow id="highValue" sourceRef="valueGateway" targetRef="managerApproval">
      <conditionExpression xsi:type="tFormalExpression">${assetDetails.purchasePrice &gt; 5000}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="lowValue" sourceRef="valueGateway" targetRef="mergeGateway">
      <conditionExpression xsi:type="tFormalExpression">${assetDetails.purchasePrice &lt;= 5000}</conditionExpression>
    </sequenceFlow>

    <sequenceFlow id="flow6" sourceRef="managerApproval" targetRef="mergeGateway" />
    <sequenceFlow id="flow7" sourceRef="mergeGateway" targetRef="custodianAcceptance" />
    <sequenceFlow id="flow8" sourceRef="custodianAcceptance" targetRef="acceptanceGateway" />

    <!-- Acceptance Gateway Flows -->
    <sequenceFlow id="accepted" sourceRef="acceptanceGateway" targetRef="updateCustody">
      <conditionExpression xsi:type="tFormalExpression">${acceptanceDecision == 'ACCEPTED'}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="notAccepted" sourceRef="acceptanceGateway" targetRef="updateRejected">
      <conditionExpression xsi:type="tFormalExpression">${acceptanceDecision == 'REJECTED'}</conditionExpression>
    </sequenceFlow>

    <!-- Completion Path -->
    <sequenceFlow id="flow9" sourceRef="updateCustody" targetRef="updateLocation" />
    <sequenceFlow id="flow10" sourceRef="updateLocation" targetRef="createTransferRecord" />
    <sequenceFlow id="flow11" sourceRef="createTransferRecord" targetRef="updateCompleted" />
    <sequenceFlow id="flow12" sourceRef="updateCompleted" targetRef="sendCompletionNotification" />
    <sequenceFlow id="flow13" sourceRef="sendCompletionNotification" targetRef="endEventCompleted" />

    <!-- Rejection Path -->
    <sequenceFlow id="flow14" sourceRef="updateRejected" targetRef="sendRejectionNotification" />
    <sequenceFlow id="flow15" sourceRef="sendRejectionNotification" targetRef="endEventRejected" />

  </process>

  <!-- BPMN Diagram (Visual Layout) -->
  <bpmndi:BPMNDiagram id="BPMNDiagram_asset-transfer-approval-process">
    <bpmndi:BPMNPlane bpmnElement="asset-transfer-approval-process" id="BPMNPlane_asset-transfer-approval-process">
      <bpmndi:BPMNShape bpmnElement="startEvent" id="BPMNShape_startEvent">
        <omgdc:Bounds height="30.0" width="30.0" x="100.0" y="163.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="custodianReleaseApproval" id="BPMNShape_custodianReleaseApproval">
        <omgdc:Bounds height="80.0" width="100.0" x="600.0" y="138.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="endEventCompleted" id="BPMNShape_endEventCompleted">
        <omgdc:Bounds height="28.0" width="28.0" x="1700.0" y="164.0"/>
      </bpmndi:BPMNShape>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</definitions>
