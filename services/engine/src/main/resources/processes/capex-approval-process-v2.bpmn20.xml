<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
             typeLanguage="http://www.w3.org/2001/XMLSchema"
             expressionLanguage="http://www.w3.org/1999/XPath"
             targetNamespace="http://werkflow.com/bpmn/capex">

  <process id="capex-approval-process-v2" name="CapEx Approval Process V2 (REST)" isExecutable="true">

    <documentation>Capital Expenditure approval workflow with multi-level approvals based on amount thresholds. V2 uses RestServiceDelegate pattern for inter-service communication.</documentation>

    <!-- Start Event -->
    <startEvent id="startEvent" name="CapEx Request Submitted" flowable:formKey="capex-request">
      <documentation>Employee submits a capital expenditure request</documentation>
    </startEvent>

    <!-- Service Task: Create CapEx Request via RestServiceDelegate -->
    <serviceTask id="createCapExRequest" name="Create CapEx Request"
                 flowable:delegateExpression="${restServiceDelegate}">
      <documentation>Creates CapEx request record in Finance Service via REST API</documentation>
      <extensionElements>
        <flowable:field name="url">
          <flowable:expression>${financeServiceUrl}/api/workflow/capex/create-request</flowable:expression>
        </flowable:field>
        <flowable:field name="method">
          <flowable:string>POST</flowable:string>
        </flowable:field>
        <flowable:field name="body">
          <flowable:expression>#{
            {
              'title': title,
              'description': description,
              'category': category,
              'amount': requestAmount,
              'priority': priority,
              'approvalLevel': approvalLevel,
              'businessJustification': businessJustification,
              'expectedBenefits': expectedBenefits,
              'expectedCompletionDate': expectedCompletionDate,
              'budgetYear': budgetYear,
              'departmentName': departmentName,
              'requestedBy': requestedBy
            }
          }</flowable:expression>
        </flowable:field>
        <flowable:field name="responseVariable">
          <flowable:string>createRequestResponse</flowable:string>
        </flowable:field>
      </extensionElements>
    </serviceTask>

    <!-- Script Task: Extract response variables from createRequestResponse -->
    <scriptTask id="extractCreateResponse" name="Extract Create Response" scriptFormat="groovy">
      <script>
        <![CDATA[
          def response = execution.getVariable('createRequestResponse')
          if (response != null) {
            execution.setVariable('capexId', response.get('capexId'))
            execution.setVariable('requestNumber', response.get('requestNumber'))
          }
        ]]>
      </script>
    </scriptTask>

    <!-- Service Task: Check Budget Availability via RestServiceDelegate -->
    <serviceTask id="checkBudget" name="Check Budget Availability"
                 flowable:delegateExpression="${restServiceDelegate}">
      <documentation>Verifies if budget is available for the requested amount</documentation>
      <extensionElements>
        <flowable:field name="url">
          <flowable:expression>${financeServiceUrl}/api/workflow/capex/check-budget</flowable:expression>
        </flowable:field>
        <flowable:field name="method">
          <flowable:string>POST</flowable:string>
        </flowable:field>
        <flowable:field name="body">
          <flowable:expression>#{
            {
              'capexId': capexId,
              'requestAmount': requestAmount,
              'departmentName': departmentName
            }
          }</flowable:expression>
        </flowable:field>
        <flowable:field name="responseVariable">
          <flowable:string>budgetCheckResponse</flowable:string>
        </flowable:field>
      </extensionElements>
    </serviceTask>

    <!-- Script Task: Extract budget check response variables -->
    <scriptTask id="extractBudgetResponse" name="Extract Budget Response" scriptFormat="groovy">
      <script>
        <![CDATA[
          def response = execution.getVariable('budgetCheckResponse')
          if (response != null) {
            execution.setVariable('budgetAvailable', response.get('budgetAvailable'))
            execution.setVariable('availableBudget', response.get('availableBudget'))
          }
        ]]>
      </script>
    </scriptTask>

    <!-- Exclusive Gateway: Budget Available? -->
    <exclusiveGateway id="budgetGateway" name="Budget Available?" />

    <!-- User Task: Department Manager Approval -->
    <userTask id="managerApproval" name="Manager Review" flowable:candidateGroups="FINANCE_MANAGER" flowable:formKey="capex-approval">
      <documentation>Department manager reviews and approves/rejects the CapEx request</documentation>
      <extensionElements>
        <flowable:taskListener event="complete" delegateExpression="${approvalTaskCompletionListener}" />
      </extensionElements>
    </userTask>

    <!-- Exclusive Gateway: Check Amount for VP Approval -->
    <exclusiveGateway id="amountGateway" name="Amount > $50,000?" />

    <!-- User Task: VP Approval (for amounts > $50k) -->
    <userTask id="vpApproval" name="VP Review" flowable:candidateGroups="FINANCE_VP" flowable:formKey="capex-approval">
      <documentation>VP reviews high-value CapEx requests exceeding $50,000</documentation>
      <extensionElements>
        <flowable:taskListener event="complete" delegateExpression="${approvalTaskCompletionListener}" />
      </extensionElements>
    </userTask>

    <!-- Exclusive Gateway: Check Amount for CFO Approval -->
    <exclusiveGateway id="cfoGateway" name="Amount > $250,000?" />

    <!-- User Task: CFO Approval (for amounts > $250k) -->
    <userTask id="cfoApproval" name="CFO Review" flowable:candidateGroups="FINANCE_CFO" flowable:formKey="capex-approval">
      <documentation>CFO reviews very high-value CapEx requests exceeding $250,000</documentation>
      <extensionElements>
        <flowable:taskListener event="complete" delegateExpression="${approvalTaskCompletionListener}" />
      </extensionElements>
    </userTask>

    <!-- Merge Gateway: Collect all approval paths -->
    <exclusiveGateway id="mergeGateway" name="Merge Approvals" />

    <!-- Exclusive Gateway: Final Decision -->
    <exclusiveGateway id="decisionGateway" name="Approved?" />

    <!-- Service Task: Update CapEx Status - Approved via RestServiceDelegate -->
    <serviceTask id="updateApproved" name="Update Status: Approved"
                 flowable:delegateExpression="${restServiceDelegate}">
      <documentation>Updates CapEx request status to APPROVED in Finance Service</documentation>
      <extensionElements>
        <flowable:field name="url">
          <flowable:expression>${financeServiceUrl}/api/workflow/capex/update-status</flowable:expression>
        </flowable:field>
        <flowable:field name="method">
          <flowable:string>PUT</flowable:string>
        </flowable:field>
        <flowable:field name="body">
          <flowable:expression>#{
            {
              'capexId': capexId,
              'status': 'APPROVED',
              'comments': approvalComments
            }
          }</flowable:expression>
        </flowable:field>
        <flowable:field name="responseVariable">
          <flowable:string>updateStatusResponse</flowable:string>
        </flowable:field>
      </extensionElements>
    </serviceTask>

    <!-- Service Task: Reserve Budget via RestServiceDelegate -->
    <serviceTask id="reserveBudget" name="Reserve Budget"
                 flowable:delegateExpression="${restServiceDelegate}">
      <documentation>Reserves the approved budget amount in the Finance Service</documentation>
      <extensionElements>
        <flowable:field name="url">
          <flowable:expression>${financeServiceUrl}/api/workflow/capex/allocate</flowable:expression>
        </flowable:field>
        <flowable:field name="method">
          <flowable:string>POST</flowable:string>
        </flowable:field>
        <flowable:field name="body">
          <flowable:expression>#{
            {
              'capexId': capexId,
              'requestAmount': requestAmount,
              'departmentName': departmentName
            }
          }</flowable:expression>
        </flowable:field>
        <flowable:field name="responseVariable">
          <flowable:string>budgetAllocationResponse</flowable:string>
        </flowable:field>
      </extensionElements>
    </serviceTask>

    <!-- Service Task: Send Approval Notification -->
    <serviceTask id="sendApprovalNotification" name="Send Approval Notification"
                 flowable:delegateExpression="${notificationDelegate}">
      <documentation>Sends email notification to requester about approval</documentation>
      <extensionElements>
        <flowable:field name="notificationType">
          <flowable:string><![CDATA[CAPEX_APPROVED]]></flowable:string>
        </flowable:field>
      </extensionElements>
    </serviceTask>

    <!-- Service Task: Update CapEx Status - Rejected via RestServiceDelegate -->
    <serviceTask id="updateRejected" name="Update Status: Rejected"
                 flowable:delegateExpression="${restServiceDelegate}">
      <documentation>Updates CapEx request status to REJECTED in Finance Service</documentation>
      <extensionElements>
        <flowable:field name="url">
          <flowable:expression>${financeServiceUrl}/api/workflow/capex/update-status</flowable:expression>
        </flowable:field>
        <flowable:field name="method">
          <flowable:string>PUT</flowable:string>
        </flowable:field>
        <flowable:field name="body">
          <flowable:expression>#{
            {
              'capexId': capexId,
              'status': 'REJECTED',
              'comments': rejectionReason
            }
          }</flowable:expression>
        </flowable:field>
        <flowable:field name="responseVariable">
          <flowable:string>updateStatusResponse</flowable:string>
        </flowable:field>
      </extensionElements>
    </serviceTask>

    <!-- Service Task: Send Rejection Notification -->
    <serviceTask id="sendRejectionNotification" name="Send Rejection Notification"
                 flowable:delegateExpression="${notificationDelegate}">
      <documentation>Sends email notification to requester about rejection</documentation>
      <extensionElements>
        <flowable:field name="notificationType">
          <flowable:string><![CDATA[CAPEX_REJECTED]]></flowable:string>
        </flowable:field>
      </extensionElements>
    </serviceTask>

    <!-- End Events -->
    <endEvent id="endEventApproved" name="Request Approved" />
    <endEvent id="endEventRejected" name="Request Rejected" />
    <endEvent id="endEventNoBudget" name="Insufficient Budget" />

    <!-- Sequence Flows -->
    <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="createCapExRequest" />
    <sequenceFlow id="flow1b" sourceRef="createCapExRequest" targetRef="extractCreateResponse" />
    <sequenceFlow id="flow2" sourceRef="extractCreateResponse" targetRef="checkBudget" />
    <sequenceFlow id="flow2b" sourceRef="checkBudget" targetRef="extractBudgetResponse" />
    <sequenceFlow id="flow3" sourceRef="extractBudgetResponse" targetRef="budgetGateway" />

    <!-- Budget Gateway Flows -->
    <sequenceFlow id="budgetYes" sourceRef="budgetGateway" targetRef="managerApproval">
      <conditionExpression xsi:type="tFormalExpression">${budgetAvailable == true}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="budgetNo" sourceRef="budgetGateway" targetRef="endEventNoBudget">
      <conditionExpression xsi:type="tFormalExpression">${budgetAvailable == false}</conditionExpression>
    </sequenceFlow>

    <!-- After manager approval, check if rejected or continue to amount-based routing -->
    <sequenceFlow id="flow4" sourceRef="managerApproval" targetRef="amountGateway" />

    <!-- Amount Gateway Flows -->
    <sequenceFlow id="managerRejected" sourceRef="amountGateway" targetRef="mergeGateway">
      <conditionExpression xsi:type="tFormalExpression">${managerApproved == false}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="amountLow" sourceRef="amountGateway" targetRef="mergeGateway">
      <conditionExpression xsi:type="tFormalExpression">${managerApproved == true &amp;&amp; requestAmount &lt;= 50000}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="amountHigh" sourceRef="amountGateway" targetRef="vpApproval">
      <conditionExpression xsi:type="tFormalExpression">${managerApproved == true &amp;&amp; requestAmount &gt; 50000}</conditionExpression>
    </sequenceFlow>

    <!-- After VP approval, check if rejected or continue to CFO routing -->
    <sequenceFlow id="flow5" sourceRef="vpApproval" targetRef="cfoGateway" />

    <!-- CFO Gateway Flows -->
    <sequenceFlow id="vpRejected" sourceRef="cfoGateway" targetRef="mergeGateway">
      <conditionExpression xsi:type="tFormalExpression">${vpApproved == false}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="cfoNotNeeded" sourceRef="cfoGateway" targetRef="mergeGateway">
      <conditionExpression xsi:type="tFormalExpression">${vpApproved == true &amp;&amp; requestAmount &lt;= 250000}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="cfoNeeded" sourceRef="cfoGateway" targetRef="cfoApproval">
      <conditionExpression xsi:type="tFormalExpression">${vpApproved == true &amp;&amp; requestAmount &gt; 250000}</conditionExpression>
    </sequenceFlow>

    <sequenceFlow id="flow6" sourceRef="cfoApproval" targetRef="mergeGateway" />
    <sequenceFlow id="flow7" sourceRef="mergeGateway" targetRef="decisionGateway" />

    <!-- Decision Gateway Flows -->
    <sequenceFlow id="approved" sourceRef="decisionGateway" targetRef="updateApproved">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[
        ${
          (managerApproved == true) &&
          (requestAmount <= 50000 || (vpApproved == true && (requestAmount <= 250000 || cfoApproved == true)))
        }
      ]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="rejected" sourceRef="decisionGateway" targetRef="updateRejected">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[
        ${
          (managerApproved == false) ||
          (requestAmount > 50000 && vpApproved == false) ||
          (requestAmount > 250000 && cfoApproved == false)
        }
      ]]></conditionExpression>
    </sequenceFlow>

    <!-- Approval Path -->
    <sequenceFlow id="flow8" sourceRef="updateApproved" targetRef="reserveBudget" />
    <sequenceFlow id="flow9" sourceRef="reserveBudget" targetRef="sendApprovalNotification" />
    <sequenceFlow id="flow10" sourceRef="sendApprovalNotification" targetRef="endEventApproved" />

    <!-- Rejection Path -->
    <sequenceFlow id="flow11" sourceRef="updateRejected" targetRef="sendRejectionNotification" />
    <sequenceFlow id="flow12" sourceRef="sendRejectionNotification" targetRef="endEventRejected" />

  </process>

  <!-- BPMN Diagram (Visual Layout) -->
  <bpmndi:BPMNDiagram id="BPMNDiagram_capex-approval-process-v2">
    <bpmndi:BPMNPlane bpmnElement="capex-approval-process-v2" id="BPMNPlane_capex-approval-process-v2">

      <bpmndi:BPMNShape bpmnElement="startEvent" id="BPMNShape_startEvent">
        <omgdc:Bounds height="30.0" width="30.0" x="100.0" y="163.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="createCapExRequest" id="BPMNShape_createCapExRequest">
        <omgdc:Bounds height="80.0" width="100.0" x="180.0" y="138.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="extractCreateResponse" id="BPMNShape_extractCreateResponse">
        <omgdc:Bounds height="80.0" width="100.0" x="330.0" y="138.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="checkBudget" id="BPMNShape_checkBudget">
        <omgdc:Bounds height="80.0" width="100.0" x="480.0" y="138.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="extractBudgetResponse" id="BPMNShape_extractBudgetResponse">
        <omgdc:Bounds height="80.0" width="100.0" x="630.0" y="138.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="budgetGateway" id="BPMNShape_budgetGateway">
        <omgdc:Bounds height="40.0" width="40.0" x="780.0" y="158.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="managerApproval" id="BPMNShape_managerApproval">
        <omgdc:Bounds height="80.0" width="100.0" x="870.0" y="138.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="amountGateway" id="BPMNShape_amountGateway">
        <omgdc:Bounds height="40.0" width="40.0" x="1020.0" y="158.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="vpApproval" id="BPMNShape_vpApproval">
        <omgdc:Bounds height="80.0" width="100.0" x="1110.0" y="138.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="cfoGateway" id="BPMNShape_cfoGateway">
        <omgdc:Bounds height="40.0" width="40.0" x="1260.0" y="158.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="cfoApproval" id="BPMNShape_cfoApproval">
        <omgdc:Bounds height="80.0" width="100.0" x="1350.0" y="138.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="mergeGateway" id="BPMNShape_mergeGateway">
        <omgdc:Bounds height="40.0" width="40.0" x="1500.0" y="158.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="decisionGateway" id="BPMNShape_decisionGateway">
        <omgdc:Bounds height="40.0" width="40.0" x="1590.0" y="158.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="updateApproved" id="BPMNShape_updateApproved">
        <omgdc:Bounds height="80.0" width="100.0" x="1680.0" y="50.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="reserveBudget" id="BPMNShape_reserveBudget">
        <omgdc:Bounds height="80.0" width="100.0" x="1830.0" y="50.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="sendApprovalNotification" id="BPMNShape_sendApprovalNotification">
        <omgdc:Bounds height="80.0" width="100.0" x="1980.0" y="50.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="updateRejected" id="BPMNShape_updateRejected">
        <omgdc:Bounds height="80.0" width="100.0" x="1680.0" y="250.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="sendRejectionNotification" id="BPMNShape_sendRejectionNotification">
        <omgdc:Bounds height="80.0" width="100.0" x="1830.0" y="250.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="endEventApproved" id="BPMNShape_endEventApproved">
        <omgdc:Bounds height="28.0" width="28.0" x="2130.0" y="76.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="endEventRejected" id="BPMNShape_endEventRejected">
        <omgdc:Bounds height="28.0" width="28.0" x="1980.0" y="276.0"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape bpmnElement="endEventNoBudget" id="BPMNShape_endEventNoBudget">
        <omgdc:Bounds height="28.0" width="28.0" x="786.0" y="250.0"/>
      </bpmndi:BPMNShape>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</definitions>
